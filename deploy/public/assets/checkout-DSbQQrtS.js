import{r as d,j as e,u as v,n as b,w as S,L as f,B as w,C as P,a as C,b as k,d as I,P as R,e as A}from"./index-sTi6BLPu.js";import{E as F,l as O,u as $,a as T,P as Y}from"./index-D94guw86.js";import{S as N}from"./separator-BcewAmr9.js";import{A as B}from"./arrow-left-DtuWXA6b.js";import{S as _}from"./shopping-cart-DjSog6GS.js";import{S as L}from"./shield-DYGAM3k4.js";import{C as E}from"./credit-card-B1A0ZWNg.js";import"./index-D04l966U.js";function q({triggerText:p="What are SPIRALS?"}){const[m,r]=d.useState(!1),[h,c]=d.useState("A");return d.useEffect(()=>{fetch("/api/flags").then(t=>t.json()).then(t=>{var n;return c(((n=t==null?void 0:t.ab)==null?void 0:n.spiralsExplainer)||"A")})},[]),e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"underline text-sm",onClick:()=>r(!0),children:p}),m&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50",onClick:()=>r(!1),children:e.jsxs("div",{className:"bg-white rounded-xl p-5 max-w-md w-full",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"SPIRALS Rewards"}),h==="A"?e.jsxs("ul",{className:"list-disc pl-5 text-sm space-y-1",children:[e.jsxs("li",{children:["Earn ",e.jsx("strong",{children:"1 SPIRAL"})," per ",e.jsx("strong",{children:"$1"})," spent."]}),e.jsx("li",{children:"100 SPIRALS = $1 credit (â‰ˆ1% back)."}),e.jsxs("li",{children:[e.jsx("strong",{children:"2Ã—"})," SPIRALS for mall pickup."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"3Ã—"}),' for "Invite to Shop".']}),e.jsxs("li",{children:["Seasonal promos run ",e.jsx("strong",{children:"only by SPIRAL"}),"."]})]}):e.jsx("p",{className:"text-sm",children:"Every purchase earns SPIRALS. Redeem at checkout. Pick up in-mall for 2Ã— and invite a friend for 3Ã—."}),e.jsx("div",{className:"mt-4 flex justify-end",children:e.jsx("button",{className:"px-3 py-2 bg-black text-white rounded-md",onClick:()=>r(!1),children:"Got it"})})]})})]})}const z=O("pk_test_51RovomEJ7kxSTVM4mZSvdUXJLoXYPvRBIZ7mKDBbXx3h0bzQMUmJOoihXtlTrKqHtrYbQmZQ9YPLVF5z39Sh4j8N00WlYRGOwL"),J=({clientSecret:p,orderDetails:m})=>{var u;const r=$(),h=T(),{toast:c}=v(),[t,n]=d.useState(!1),l=b(o=>o.clearCart),[,j]=S(),x=async o=>{if(o.preventDefault(),!(!r||!h)){n(!0);try{const{error:a,paymentIntent:s}=await r.confirmPayment({elements:h,confirmParams:{return_url:`${window.location.origin}/order-confirmation`},redirect:"if_required"});if(a)c({title:"Payment Failed",description:a.message,variant:"destructive"});else if(s&&s.status==="succeeded")try{const g=await(await fetch("/api/process-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:s.id,orderData:m,spiralPoints:m.spiralPointsUsed||0})})).json();if(g.success)l(),c({title:"Payment Successful!",description:`Order confirmed! You earned ${g.spiralPointsEarned} SPIRAL points.`}),j("/order-confirmation?payment_intent="+s.id);else throw new Error(g.error||"Order processing failed")}catch{c({title:"Payment Successful, Order Processing Issue",description:"Your payment went through, but there was an issue processing your order. Please contact support.",variant:"destructive"})}}catch(a){c({title:"Payment Error",description:a.message||"An unexpected error occurred",variant:"destructive"})}finally{n(!1)}}};return e.jsxs(P,{className:"w-full max-w-md mx-auto",children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"Complete Your Payment"]})}),e.jsx(I,{children:e.jsxs("form",{onSubmit:x,className:"space-y-6",children:[e.jsx(Y,{options:{layout:"tabs"}}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(L,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{children:"Secured by Stripe â€¢ Your payment information is encrypted"})]}),e.jsx(w,{type:"submit",disabled:!r||t,className:"w-full mobile-button bg-[var(--spiral-coral)] hover:bg-[var(--spiral-coral)]/90",children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"}),"Processing..."]}):`Pay $${((u=m.total)==null?void 0:u.toFixed(2))||"0.00"}`})]})})]})};function G(){const[p,m]=d.useState(""),[r,h]=d.useState(null),[c,t]=d.useState(!0),{toast:n}=v(),l=b(s=>s.items),[,j]=S(),x=l.reduce((s,i)=>s+i.price*i.quantity,0),u=x*.0875,o=x>50?0:5.99,a=x+u+o;return d.useEffect(()=>{if(l.length===0){n({title:"Empty Cart",description:"Your cart is empty. Add some items before checking out.",variant:"destructive"}),j("/products");return}(async()=>{try{t(!0);const i={items:l,subtotal:x,tax:u,shipping:o,total:a,metadata:{source:"SPIRAL_checkout",itemCount:l.length}},y=await(await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:a,metadata:i.metadata})})).json();if(y.success)m(y.clientSecret),h(i);else throw new Error(y.error||"Failed to create payment intent")}catch(i){n({title:"Checkout Error",description:i.message||"Failed to initialize checkout",variant:"destructive"}),j("/cart")}finally{t(!1)}})()},[l,a,j,n]),c?e.jsx("div",{className:"min-h-screen bg-gray-50 py-8 px-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-[var(--spiral-coral)] border-t-transparent rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Preparing your checkout..."})]})})})}):p?e.jsx("div",{className:"min-h-screen bg-gray-50 py-4 sm:py-8 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsxs(f,{to:"/cart",className:"inline-flex items-center gap-2 text-[var(--spiral-navy)] hover:text-[var(--spiral-navy)]/80 mb-4",children:[e.jsx(B,{className:"w-4 h-4"}),"Back to Cart"]}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900",children:"Checkout"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Complete your purchase securely with Stripe"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8",children:[e.jsx("div",{className:"space-y-6",children:e.jsxs(P,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5"}),"Order Summary"]})}),e.jsxs(I,{className:"space-y-4",children:[l.map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[s.image?e.jsx("img",{src:s.image,alt:s.name,className:"w-16 h-16 object-cover rounded-lg"}):e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center",children:e.jsx(R,{className:"w-6 h-6 text-gray-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600",children:s.store}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Qty: ",s.quantity]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-medium",children:["$",(s.price*s.quantity).toFixed(2)]})})]},s.id)),e.jsx(N,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["$",x.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Tax"}),e.jsxs("span",{children:["$",u.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Shipping"}),e.jsx("span",{children:o===0?"Free":`$${o.toFixed(2)}`})]}),e.jsx(N,{}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",a.toFixed(2)]})]})]}),e.jsxs("div",{className:"bg-green-50 p-3 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-green-700",children:["ðŸ’° You'll earn ",e.jsx("strong",{children:Math.floor(a*5)})," SPIRAL points with this purchase!"]}),e.jsx("div",{className:"mt-2",children:e.jsx(q,{triggerText:"How SPIRALS work"})})]})]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(F,{stripe:z,options:{clientSecret:p},children:e.jsx(J,{clientSecret:p,orderDetails:r})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"p-4 bg-white rounded-lg",children:[e.jsx(L,{className:"w-8 h-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium",children:"Secure"}),e.jsx("p",{className:"text-xs text-gray-600",children:"SSL Encrypted"})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg",children:[e.jsx(E,{className:"w-8 h-8 text-blue-600 mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium",children:"Stripe"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Payment Processing"})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg",children:[e.jsx(A,{className:"w-8 h-8 text-[var(--spiral-coral)] mx-auto mb-2"}),e.jsx("p",{className:"text-sm font-medium",children:"SPIRAL"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Rewards Included"})]})]})]})]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-8 px-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-gray-600",children:"Unable to initialize checkout. Please try again."}),e.jsx(f,{to:"/cart",children:e.jsx(w,{className:"mt-4",children:"Return to Cart"})})]})})})}export{G as default};
